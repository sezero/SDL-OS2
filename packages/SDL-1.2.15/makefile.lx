# FOR CROSS-COMPILING UNDER LINUX
#=============================================================================
#
#  This is an OpenWatcom makefile to build alternative version SDL for OS/2
#
#  * A new VMAN and DIVE support
#  * A new DART support
#
# Digi 2014.
#=============================================================================

DLLNAME = SDL12
VERSION = 1.2.15
INCPATH =-Iinclude -Isrc/video/os2grop -Isrc/video/os2grop/grop

!include ../../packages.lx

# Create debug build or not?
#DEBUG_BUILD=1

#
#==============================================================================
#

# Special flags for building SDL
CFLAGS=$(CFLAGS_DLL) -otexan -wx -ei
CFLAGS+= -DBUILD_SDL
# -DCHECK_LEAKS
# USE_ASM_MIXER_VC has no effect since SDL-1.2.10.
# -DUSE_ASM_MIXER_VC
CFLAGS+= -DICONV_INBUF_NONCONST
CFLAGS+= -DUSE_DOSSETPRIORITY

DESCRIPTION = Simple DirectMedia Layer (alternative port)

!ifdef DEBUG_BUILD
CFLAGS += -d2 -DDEBUG_BUILD
CFLAGS += -DDEBUG_FILE=\"SDL.dbg\"
DESCRIPTION += DEBUG
!endif

PMGRE_LIB = $(LIBPATH)/pmgre.lib
PMGRE_DEF = $(LIBPATH)/pmgre.def
PMGRE_EXP = $(LIBPATH)/pmgre.exp

audioobjs = SDL_audiocvt.obj SDL_mixer.obj SDL_mixer_MMX_VC.obj SDL_wave.obj &
            SDL_audio_os2.obj
# SDL_audio.obj SDL_dummyaudio.obj SDL_diskaudio.obj SDL_dart.obj

cdromobjs = SDL_cdrom.obj SDL_syscdrom.obj
cpuinfoobjs = SDL_cpuinfo.obj
eventsobjs = SDL_active.obj SDL_events.obj SDL_expose.obj SDL_keyboard.obj &
             SDL_mouse.obj SDL_quit.obj SDL_resize.obj
fileobjs = SDL_rwops.obj
joystickobjs = SDL_joystick.obj SDL_sysjoystick.obj
loadsoobjs = SDL_sysloadso.obj
threadobjs = SDL_thread.obj SDL_sysmutex.obj SDL_syssem.obj SDL_systhread.obj &
             SDL_syscond.obj
timerobjs = SDL_timer.obj SDL_systimer.obj
videoobjs = SDL_blit.obj SDL_blit_0.obj SDL_blit_1.obj SDL_blit_A.obj &
            SDL_blit_N.obj SDL_bmp.obj SDL_cursor.obj SDL_gamma.obj &
            SDL_pixels.obj SDL_RLEaccel.obj SDL_stretch.obj SDL_surface.obj &
            SDL_video.obj SDL_yuv.obj SDL_yuv_mmx.obj SDL_yuv_sw.obj &
            SDL_os2grop.obj os2ini.obj debug.obj grop.obj vs_dive.obj &
            vs_vman.obj
# SDL_nullevents.obj SDL_nullmouse.obj SDL_nullvideo.obj SDL_os2fslib.obj

stdlibobjs = SDL_string.obj
# SDL_iconv.obj

object_files= SDL.obj SDL_error.obj SDL_fatal.obj &
              $(stdlibobjs) $(audioobjs) $(cpuinfoobjs) $(eventsobjs) &
              $(fileobjs) $(joystickobjs) $(loadsoobjs) $(threadobjs) &
              $(timerobjs) $(videoobjs) $(cdromobjs)

.extensions:
.extensions: .lib .dll .obj .c .asm

.c: src;src/audio;src/cdrom;src/cdrom/os2;src/cpuinfo;src/events;src/file;src/joystick;src/joystick/os2;src/loadso/os2;src/stdlib;src/thread;src/thread/os2;src/timer;src/timer/os2;src/video;src/video/os2grop;src/video/os2grop/grop
#;src/audio/dummy;src/audio/disk;src/audio/dart;src/video/dummy;src/video/os2fslib

.c.obj:
	wcc386 $(CFLAGS) -fo=$^@ $<

all: $(DLLFILE) $(LIBFILE) .symbolic

$(DLLFILE): compiling_info $(object_files) $(LNKFILE) $(PMGRE_LIB) dll_dir lib_dir
	@echo * Linking: $@
	@wlink @$(LNKFILE)

$(LIBFILE): $(DLLFILE)
	@echo * Creating LIB file: $@
	wlib -q -b -n -c -pa -s -t -zld -ii -io $* $(DLLFILE)

SDL_RLEaccel.obj:
	wcc386 $(cflags) -w1 -fo=$^@ src/video/SDL_RLEaccel.c

dll_dir: .symbolic
	@if not exist $(DLLPATH) mkdir $(DLLPATH)
lib_dir: .symbolic
	@if not exist $(LIBPATH) mkdir $(LIBPATH)

compiling_info : .symbolic
	@echo * Compiling...

$(PMGRE_LIB): $(PMGRE_EXP)
	wlib -q -b -n -c -pa -s -t -zld -ii -io $(PMGRE_LIB) @$(PMGRE_EXP)

$(PMGRE_EXP): $(PMGRE_DEF) $(LIBPATH)/def2lbc.sed
	@echo * Creating PMGRE import library
	sed -f $(LIBPATH)/def2lbc.sed $(PMGRE_DEF) > $(PMGRE_EXP)

$(LNKFILE):
	@echo * Creating linker file: $@
	@%create $@
	@%append $@ SYSTEM os2v2_dll INITINSTANCE TERMINSTANCE
	@%append $@ NAME $(DLLPATH)/$(LIBNAME)
	@for %i in ($(object_files)) do @%append $@ FILE %i
	@%append $@ LIBPATH $(LIBPATH)
	@%append $@ LIB os2386.lib
	@%append $@ LIB pmgre.lib
	@%append $@ LIB mmpm2.lib
	@%append $@ LIB libuls.lib
	@%append $@ LIB libconv.lib
#	@%append $@ LIB os2iconv_static.lib
	@%append $@ OPTION QUIET
	@%append $@ OPTION IMPF=$^&.exp
	@%append $@ OPTION MAP=$^&.map
!ifdef %osdir
	@$(%osdir)\KLIBC\BIN\date +"OPTION DESCRIPTION '@$#libsdl org:$(VERSION)$#@$#$#1$#$# %F               $(%HOSTNAME)::::::@@Simple DirectMedia Layer (alternative port)'" >>$^@
!else
	@%append $@ OPTION DESCRIPTION '@$#libsdl org:$(VERSION)$#@$(DESCRIPTION)'
!endif
	@%append $@ OPTION QUIET
	@%append $@ OPTION ELIMINATE
	@%append $@ OPTION MANYAUTODATA
	@%append $@ OPTION OSNAME='OS/2 and eComStation'
	@%append $@ OPTION SHOWDEAD

clean: .SYMBOLIC
	@ echo * Clean: $(TITLENAME)
	@if exist *.obj rm *.obj
	@if exist *.map rm *.map
	@if exist *.exp rm *.exp
	@if exist $(LNKFILE) rm $(LNKFILE)
	@if exist $(LIBPATH)/pmgre.exp rm $(PMGRE_EXP)
	@if exist $(LIBPATH)/pmgre.lib rm $(PMGRE_LIB)

distclean: clean .SYMBOLIC
	@if exist $(DLLFILE) rm $(DLLFILE)
	@if exist $(LIBFILE) rm $(LIBFILE)

